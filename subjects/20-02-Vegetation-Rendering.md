# 20.2 Vegetation Rendering

[← Back to Chapter 20](../chapters/20-Specialized-Rendering.md) | [Main Index](../README.md)

Vegetation rendering optimizes trees, grass, and foliage: SpeedTree integration, GPU instancing for thousands of objects, alpha cutout optimization, wind animation, and LOD systems.

---

## Overview

Vegetation Challenges: High instance counts (forests = 10,000+ trees, grass = millions of blades), alpha cutout (leaves use transparency, expensive overdraw), wind animation (vertex animation, must be cheap), LOD critical (trees viewed from meters to kilometers, extreme LOD range). Performance balance: visual density (lush forests, thick grass) vs frame rate (each tree/grass = cost, thousands = optimization mandatory).

SpeedTree: Industry-standard vegetation tool (procedural tree generation, optimized LODs, wind animation shaders). Unity integration (SpeedTree assets import directly, automatic LOD setup, Unity renders efficiently). Benefits: production-quality trees (realistic branching, seasonal variations, 8 LOD levels including billboards), optimized (GPU instancing compatible, efficient shaders, tested across platforms). Alternative: manual modeling (Blender/Maya trees, custom LODs, more work but custom art style possible).

Rendering Strategies: GPU Instancing (mandatory, thousands of trees = one draw call per LOD level), alpha cutout (transparency for leaves, alpha testing in shader, overdraw management critical), billboard LODs (distant trees = 2-tri billboards, 3D meshes near camera only), occlusion culling (trees behind hills culled, reduces draw calls). Grass rendering: detail mesh system (Unity Terrain detail system, GPU instancing, millions of grass instances), or custom (mesh shaders, GPU-driven rendering for advanced effects).

## Key Concepts

- **SpeedTree Assets**: Procedural tree models (.spm files), Unity imports as prefab (mesh + materials + LOD Group). LOD levels: LOD0 = highest detail (5,000-10,000 tris, visible 0-10m), LOD1/2/3 (progressive reduction, 2,000/1,000/500 tris), Billboard (2 tris, cross-quad or single billboard, 100m+). Materials: bark (opaque, PBR material), leaves (alpha cutout, two-sided rendering, wind animation). Wind: vertex shader animation (branch bending, leaf flutter, driven by wind zones), performance-cheap (pure math, no physics).
- **GPU Instancing**: Render thousands of identical objects in one draw call (one tree mesh, rendered 10,000 times with different transforms). Unity setup: enable GPU Instancing on material (Material > Enable GPU Instancing checkbox), renderer supports (MeshRenderer + LODGroup compatible). Drawing: Unity batches instances automatically (all trees with same mesh+material = one instanced draw call). Limits: 1023 instances per draw call (DirectX 11 limit, larger batches split automatically), same material (different materials = separate draws, minimize material variations).
- **Alpha Cutout Optimization**: Leaves use alpha testing (fragment shader: `clip(alpha - 0.5)`, discards transparent pixels). Overdraw problem: many overlapping leaf quads (alpha tested, but GPU still processes all layers, 10-20x overdraw typical on foliage). Optimization: reduce leaf density (fewer quads, maintain visual density via texture detail), alpha-to-coverage (A2C, uses MSAA samples as alpha, smoother edges + better performance than alpha test), depth prepass (render trees in depth-only pass first, then color pass skips occluded fragments = reduces overdraw). Mobile: aggressive leaf reduction (10-20 quads per tree, vs 100+ on PC, accept less dense look).
- **Wind Animation**: Vertex shader offsets vertices (sine waves, Perlin noise, simulates wind). Implementation: vertex color controls influence (red = trunk static, green = leaves animate heavily), shader: `offset = sin(worldPos.x + _Time.y * windSpeed) * windStrength * vertexColor.g;` Branch animation (primary wind, slow sine wave, bends entire tree), leaf flutter (secondary wind, fast high-frequency noise, individual leaves). Wind Zones: Unity component (WindZone, defines wind direction/strength/turbulence), shaders read wind parameters (_WindZone uniform), animate accordingly. Cost: cheap (vertex shader math, no physics, thousands of animated trees = <1ms).
- **Vegetation LOD**: Aggressive LOD strategy (trees visible extreme distances, LOD range 0-1000m+). LOD0 (0-10m, hero trees, full detail, player walks near), LOD1 (10-30m, reduced detail, still recognizable), LOD2 (30-100m, simple mesh, silhouette correct), Billboard (100-500m, 2 tris, texture only), Cull (>500m, invisible). Crossfading: Unity LODGroup crossfade (dithered fade between LODs, smooth transitions, eliminates popping). SpeedTree LODs (8 levels, finer gradation, smoother transitions than manual 4-level LOD).
- **Grass Instancing**: Millions of grass blades (Unity Terrain detail system handles, GPU instancing mandatory). Detail mesh: low-poly grass (5-10 tris per blade, cross-quads or single planes), alpha cutout (grass silhouette), wind shader (vertex animation, grass sways). Culling: render grass only near camera (Detail Distance = 50-100m, grass beyond invisible), density LOD (100% density near camera, 50% at 50m, 10% at 100m, automatic reduction). Rendering: one draw call per grass type (GPU instancing, 1M instances = single draw, amazing performance). Profiler: validate instancing active (Frame Debugger shows "Draw Mesh Instanced", not individual draws).

## Best Practices

**SpeedTree Integration:**
- Import settings: SpeedTree asset import (Unity detects .spm, imports as prefab), LOD Group auto-created (8 LOD levels, billboard LOD final), materials (bark/leaves materials, wind shaders assigned). Validate: select prefab, Inspector shows LOD Group (preview LOD levels, verify billboard present).
- Material setup: Bark material (Opaque rendering, PBR, normal map + occlusion), Leaves material (Cutout rendering, alpha testing, two-sided via shader, wind animation). Enable instancing (both materials > Enable GPU Instancing, critical for performance). Wind settings: SpeedTree wind shader (Unity SpeedTree8 shader, wind parameters: Speed, Flexibility, Randomness).
- Placement: Unity Terrain Paint Trees (SpeedTree prefab as tree, paint on terrain, GPU instancing automatic), or manual placement (prefabs in scene, ensure LODGroup + instancing enabled). Density: PC = high density (1 tree per 10-20m², forests look lush), Console = moderate (1 per 30m²), Mobile = low (1 per 50-100m², sparse vegetation).
- LOD tuning: LODGroup settings (screen relative height thresholds, adjust per project, default = 60%/30%/15%/7% for 4 LODs), Billboard Start distance (adjust for performance, earlier billboard = faster, later = higher quality). Crossfade: enable LOD crossfade (smooth transitions, 5-10m fade range typical, dithering pattern visible up close = acceptable).

**Custom Tree LOD:**
- Modeling: LOD0 (high-poly, 5,000-10,000 tris, detailed branching, many leaf clusters), LOD1 (simplified, 2,000 tris, reduce branch subdivisions, merge small branches), LOD2 (low-poly, 500-1,000 tris, simple trunk + major branches, few leaf clusters), Billboard (bake in DCC tool, orthographic render from 4-8 angles, combine into sprite sheet). Export: separate meshes (Tree_LOD0.fbx, Tree_LOD1.fbx, Tree_LOD2.fbx), or single FBX with LOD0/1/2 as children.
- LODGroup setup: Add LOD Group component (Tree GameObject), assign LOD0/1/2 renderers (drag meshes into LOD levels), set screen heights (LOD0 = 0-60%, LOD1 = 60-30%, LOD2 = 30-5%, Billboard = 5-0.1%, Cull = <0.1%). Crossfade: optional (LOD Group > Fade Mode = Cross Fade, Fade Transition Width = 0.1-0.5).
- Billboard creation: Render to texture (orthographic camera, render tree from multiple angles: front/back/left/right or 8 angles for octahedral), combine into atlas (sprite sheet with views), assign to quad mesh (2 tris, shader samples atlas based on view angle). Or: Unity billboard renderer (Billboard Renderer component, asset store tools, or manual implementation).

**Grass Optimization:**
- Mesh simplicity: 5-10 tris per grass blade (cross-quad = 4 tris, single vertical plane = 2 tris, small tuft = 10 tris), avoid high-poly (100 tri grass blades = overkill, invisible at distance). Alpha cutout (grass silhouette, alpha test in shader), texture detail (normal map on grass = excessive, diffuse only sufficient).
- Density management: Near camera 100% density (lush look, 100-200 instances per m²), mid-range 50% (30-50m, half instances, still dense appearance), far 10% (80-100m, sparse, acceptable from distance). Unity Terrain (Detail Distance + Detail Density settings control, automatic reduction), or custom (script culls grass instances based on distance).
- Instancing validation: Material > Enable GPU Instancing (mandatory), Frame Debugger (verify "Draw Mesh (instanced)" for grass, not individual draws), Profiler (single draw call for grass type, thousands of instances). Without instancing (thousands of draw calls, CPU bottleneck, unplayable).
- Grass LOD: Simple approach (single grass mesh, cull at distance, no LOD complexity), or billboard transition (3D grass near, billboard grass far, crossfade at 10-20m). Avoid complex LOD (grass too small for noticeable LOD transitions, culling more effective than LOD). Shadow casting: disable (grass casts shadows = expensive, thousands of shadow casters, disable via Renderer > Cast Shadows = Off, shadows from trees sufficient).

**Alpha Cutout Performance:**
- Alpha-to-Coverage (A2C): Enable in shader (`AlphaToMask On` in ShaderLab), requires MSAA (A2C uses MSAA samples to represent alpha, 4x MSAA = 4 alpha levels, smoother edges than binary alpha test). Benefits: reduces aliasing (smooth leaf edges, no jaggies), better performance (early-Z culling works better with A2C, less overdraw). Setup: Project Settings > Quality > Anti Aliasing = 4x MSAA (or higher), shader: `AlphaToMask On`, material Rendering Mode = Cutout.
- Depth Prepass: Render trees in depth-only pass (writes depth buffer, no color), then main color pass (early-Z culling discards occluded fragments, reduces overdraw). Implementation: two-pass shader (Pass 1: ZWrite On, ColorMask 0, renders depth only, Pass 2: ZWrite Off, ZTest Equal, renders color only visible fragments). Savings: 30-50% fragment cost (overlapping leaves, depth prepass culls hidden fragments). Cost: additional draw calls (2x draws per tree, balance vs fragment savings).
- Leaf density reduction: Reduce quad count (LOD0 = 100 leaf quads, LOD1 = 50, LOD2 = 20, fewer overlapping quads = less overdraw), texture detail (bake leaf detail into texture, fewer quads needed for dense appearance). Maintain silhouette (outer leaves important, inner culled = invisible, aggressive interior culling acceptable).
- Sorting: disable Z-write on leaves (ZWrite Off, allows alpha blending, but breaks sorting = accept for vegetation, distant trees don't need perfect sorting), or keep Z-write (ZWrite On, better sorting but more overdraw). Test: Z-write Off typically better for foliage (overdraw reduced, sorting artifacts minor on trees).

**Wind Shader Implementation:**
- Vertex color influence: Red channel = rigidity (0 = full animation, 1 = static, trunk has high red = doesn't bend), Green = primary wind (branch bending), Blue = secondary wind (leaf flutter). DCC tool paints vertex colors (Blender/Maya, trunk red, branches green, leaves green+blue), shader respects: `offset *= (1.0 - vertexColor.r);` (red areas don't move).
- Wind calculation: Primary wind (slow sine wave, `sin(_Time.y * _WindSpeed + worldPos.x) * _WindStrength`, entire tree sways), Secondary wind (fast noise, `PerlinNoise((worldPos + _Time.y * _FlutterSpeed) * _FlutterFrequency) * _FlutterStrength`, leaf-level flutter). Combine: `totalWind = primaryWind * vertexColor.g + secondaryWind * vertexColor.b;`
- Wind Zones: Unity WindZone component (defines global wind, direction + strength + turbulence), shaders read: `_WindDirection`, `_WindStrength` (Unity sets via shader globals). Alternative: custom wind (script sets wind parameters, `material.SetVector("_CustomWind", windVector)`, per-tree wind control).
- Performance: Vertex shader only (no fragment cost, pure ALU math, thousands of trees = <1ms wind animation), avoid per-frame updates (wind parameters static or slow-changing, update every 0.1 sec = smooth enough, reduces SetFloat calls). Mobile: simpler wind (single sine wave, no noise, primary wind only, flutter disabled on low-end).

**Platform-Specific:**
- **PC**: High-density vegetation (10,000+ trees, millions of grass blades, SpeedTree 8 LODs, full wind animation), aggressive instancing (mandatory, all vegetation instanced), MSAA + A2C (4x MSAA enables alpha-to-coverage, smooth foliage edges). Target: 60 FPS with dense forests (profile, Profiler > Rendering shows vegetation cost, optimize if >10ms).
- **Consoles**: Moderate density (5,000 trees, reduced grass density), SpeedTree or custom (6 LODs typical, billboard 100m), wind (full animation, consoles handle vertex shaders well), instancing (essential, supported on all consoles). Memory: watch texture memory (tree textures + grass = 50-100MB, compress, reduce resolution if needed). PS4/Xbox One: target 30 FPS (vegetation budget 5-10ms), PS5/Series X: 60 FPS viable (higher density possible).
- **Switch**: Low density (2,000 trees max, minimal grass), simple LODs (4 levels, billboard 50m, aggressive culling), reduced wind (primary wind only, no flutter, or disable on handheld mode), instancing (supported but limit counts, <1,000 grass instances per m²). Textures: low-resolution (512x512 tree textures, 256x256 grass, ASTC compression mandatory). Target: 30 FPS (vegetation budget 3-5ms, aggressive optimization required).
- **Mobile**: Minimal vegetation (hundreds of trees, sparse grass or no grass), ultra-simple (2-3 LODs, billboard 20m, cull beyond 100m), no wind (static trees, wind = optional high-end feature only), instancing (essential, even low counts benefit). Textures: very low-resolution (256-512 tree textures, 128 grass, ASTC 8x8 blocks). Target: 30 FPS (vegetation budget 2-3ms, consider baked imposters instead of 3D trees).

## Common Pitfalls

**Instancing Not Enabled**: Developer places 1,000 trees (SpeedTree prefabs), forgets to enable GPU Instancing on materials, Unity renders each tree individually (1,000 draw calls per LOD level, 4,000+ total draw calls). CPU bottleneck, frame rate single-digits. Symptom: Profiler shows thousands of draw calls (Rendering > Draw Calls = 5,000+), CPU bound (waiting on rendering). Solution: Enable GPU Instancing (all tree/grass materials > Enable GPU Instancing checkbox, verify in Frame Debugger shows "Draw Mesh (instanced)", draw calls drop to <10 per LOD level).

**Excessive Leaf Overdraw**: Developer creates detailed tree (LOD0 = 200 leaf quads, dense canopy, alpha cutout), many trees overlap (forest scene, 10-20 trees on screen), overdraw 50-100x (GPU processes every leaf layer, extreme fragment cost). Frame rate 10 FPS. Symptom: GPU bottleneck (Profiler shows fragment shading expensive), Scene view overdraw mode = bright white/red (extreme overdraw), trees dominate GPU time. Solution: Reduce leaf quads (LOD0 = 50-100 quads, still looks dense, less overdraw), depth prepass (render depth first, cull hidden fragments), alpha-to-coverage (enable MSAA + A2C, better performance than alpha test), aggressive LOD (switch to LOD1 earlier, 15m instead of 30m, fewer quads sooner).

**Missing Billboard LOD**: Developer creates tree LOD Group (LOD0/1/2 meshes, 5000/2000/500 tris), no billboard LOD (LOD2 renders at all distances, 500 tris per tree even at 500m). 1,000 distant trees = 500K tris rendered (mostly <10 pixels on screen, wasted). Performance poor. Symptom: High triangle count (Profiler shows millions of tris, mostly from distant trees), GPU vertex processing expensive. Solution: Add billboard LOD (LOD3 = 2 tri billboard, transition at 100m, or LOD Group > Cull at 500m if billboard unavailable), validate (Frame Debugger shows billboards rendering at distance, tris drop from 500 to 2 per tree).

**Wind Shader in Fragment**: Developer implements wind animation in fragment shader (thinking per-pixel wind = more detailed), wind calculates per pixel (thousands of pixels per tree, expensive sine/noise calculations repeated). GPU fragment-bound, frame rate drops. Symptom: Profiler shows fragment shading expensive (tree material dominates GPU time), wind disabled = frame rate doubles. Solution: Wind in vertex shader only (calculate offset per vertex, interpolate across pixels, zero fragment cost, visual result identical = vertices define shape, pixels just shaded). Move wind code to vertex function (vertex shader applies worldPos offset, fragment shader unchanged).

## Tools & Workflow

**SpeedTree Import**: SpeedTree Modeler (external tool, speedtree.com, generates .spm files), or SpeedTree Asset Store (pre-made tree packs). Import: drag .spm into Unity Assets folder (Unity imports automatically, creates prefab + materials + meshes), or download Asset Store pack (assets ready-to-use). Settings: select imported asset, Inspector shows SpeedTree import settings (LOD settings, wind settings, material generation). Prefab: instantiate in scene, or assign to Terrain Paint Trees (tree appears in tree palette, paint on terrain).

**LOD Group Setup**: Add LOD Group component (Tree GameObject > Add Component > LOD Group). Configure: LOD Group Inspector (shows LOD bar, drag handles to adjust screen height thresholds), Add renderers (drag child meshes into LOD0/1/2 slots, LOD Group enables/disables based on distance). Preview: LOD Group camera icon (move slider to preview LOD transitions, validate billboards appear). Culled: far right of LOD bar (objects beyond culled entirely, adjust percentage or extend with billboard LOD).

**Billboard Renderer**: Create billboard asset (Assets > Create > Billboard Asset), assign to Billboard Renderer component (GameObject > Add Component > Rendering > Billboard Renderer). Bake: Billboard Asset Inspector > Generate Billboard (Unity renders object from multiple angles, bakes into atlas), configure views (4/8/16 views, more = better quality + larger texture). Shader: Billboard shader (auto-assigned, samples atlas based on view angle, rotates billboard to face camera). Use: LODGroup LOD3 (assign Billboard Renderer as final LOD, transition at 100-200m).

**Terrain Detail Painting**: Terrain Inspector > Paint Details > Edit Details (add detail mesh). Settings: Detail Prefab (grass mesh prefab), Render Mode (Grass shader = alpha cutout + wind, VertexLit = simple lighting), Min/Max Width/Height (size variation, randomness), Noise Spread (pattern randomness), Enable GPU Instancing (checkbox, mandatory). Painting: select detail (click thumbnail), brush (size/opacity/target strength = density), LMB paints details (grass instances appear, density per m² controlled by Target Strength).

**Wind Zone**: GameObject > Light > Wind Zone (creates WindZone component). Settings: Mode (Directional = global wind, Spherical = localized wind like fan), Strength (wind force, 0-1, 0.5 typical), Turbulence (randomness, 0-1, 0.3 typical), Pulse Magnitude/Frequency (wind gusts, oscillation). Shaders: Unity SpeedTree/Nature shaders read WindZone automatically (no manual setup, wind parameters passed via globals), custom shaders (read `_Wind` uniforms, apply to vertex offset).

**Profiling Vegetation**: Unity Profiler > Rendering: Triangles (tree vertex count, validate LODs reducing tris at distance), Draw Calls (instancing should keep low, <50 draws for thousands of trees). GPU Profiler: shows vegetation rendering cost (vertex shading for wind, fragment for overdraw). Frame Debugger: expand draws (verify "Draw Mesh (instanced)" for trees/grass, check LOD levels rendering, validate billboards at distance). Scene Overdraw Mode: Scene view > Shaded > Overdraw (visualizes overdraw, trees = red/white if excessive, optimize via leaf reduction).

## Related Topics

- [20.1 Terrain Rendering](20-01-Terrain-Rendering.md) - Terrain + vegetation integration
- [17.1 LOD Fundamentals](17-01-LOD-Fundamentals.md) - LOD systems
- [5.2 GPU Optimization](05-02-GPU-Optimization.md) - GPU performance
- [12.2 Writing Custom Shaders](12-02-Writing-Custom-Shaders.md) - Custom vegetation shaders

---

[← Previous: 20.1 Terrain Rendering](20-01-Terrain-Rendering.md) | [Next: 20.3 Water and Fluid Rendering →](20-03-Water-And-Fluid-Rendering.md)
